<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hamilton Urban Forest — Climate Vulnerability Dashboard</title>

<!-- Leaflet -->
<link  rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Vega-Lite -->
<script src="https://cdn.jsdelivr.net/npm/vega@5/build/vega.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5/build/vega-lite.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6/build/vega-embed.min.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:     #0e1117;
  --panel:  #161b22;
  --border: #30363d;
  --accent: #58a6ff;
  --green:  #3fb950;
  --red:    #f85149;
  --gold:   #d29922;
  --text:   #e6edf3;
  --muted:  #8b949e;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  /* prevent horizontal overflow */
  overflow-x: hidden;
}

/* ── header ── */
header {
  padding: 18px 28px 14px;
  border-bottom: 1px solid var(--border);
}
header h1 { font-size: 1.15rem; font-weight: 700; color: var(--accent); }
header p  { font-size: .75rem; color: var(--muted); margin-top: 3px; }

/* ── controls ── */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 14px 28px;
  border-bottom: 1px solid var(--border);
  align-items: flex-end;
}
.ctrl label {
  display: block;
  font-size: .65rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .07em;
  margin-bottom: 5px;
}
select {
  background: var(--panel);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 5px 10px;
  font-size: .83rem;
  cursor: pointer;
  max-width: 220px;
}
.slider-wrap { display: flex; flex-direction: column; gap: 3px; }
input[type=range] { width: 180px; accent-color: var(--accent); cursor: pointer; }
.ticks {
  display: flex;
  justify-content: space-between;
  width: 180px;
  font-size: .62rem;
  color: var(--muted);
}

/* ── KPIs ── */
.kpis {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 14px 28px;
  border-bottom: 1px solid var(--border);
}
.kpi {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 16px;
  min-width: 120px;
  flex: 1;
}
.kpi .num { font-size: 1.4rem; font-weight: 700; }
.kpi .lbl { font-size: .65rem; color: var(--muted); margin-top: 2px; }
.red   { --c: var(--red);    } .red   .num { color: var(--red);   }
.green { --c: var(--green);  } .green .num { color: var(--green); }
.blue  { --c: var(--accent); } .blue  .num { color: var(--accent);}
.gold  { --c: var(--gold);   } .gold  .num { color: var(--gold);  }

/* ── dashboard grid ── */
.dash {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
}
.cell {
  background: var(--panel);
  padding: 18px 20px;
  /* prevent child from overflowing */
  overflow: hidden;
  min-width: 0;
}
.cell.wide { grid-column: 1 / 3; }
.cell h2 {
  font-size: .72rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .08em;
  margin-bottom: 12px;
}

/* ── Leaflet map ── */
#map {
  width: 100%;
  height: 400px;
  border-radius: 6px;
  background: #161b22;
}

/* Leaflet dark-mode overrides */
.leaflet-container { background: #161b22 !important; }
.leaflet-control-zoom a {
  background: #21262d !important;
  color: var(--text) !important;
  border-color: var(--border) !important;
}
.leaflet-popup-content-wrapper, .leaflet-popup-tip {
  background: #21262d;
  color: var(--text);
  border: 1px solid var(--border);
}

/* map legend */
.map-legend {
  background: #21262d;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
  font-size: .72rem;
  color: var(--text);
  line-height: 1.7;
  min-width: 130px;
}
.map-legend strong { display: block; margin-bottom: 4px; color: var(--muted); }
.legend-bar {
  width: 100%;
  height: 10px;
  border-radius: 3px;
  margin: 6px 0 3px;
}
.legend-ticks { display: flex; justify-content: space-between; font-size: .6rem; color: var(--muted); }

/* ── ward permanent tooltip labels ── */
.ward-label-tooltip {
  background: rgba(14,17,23,0.75);
  border: 1px solid #30363d;
  border-radius: 4px;
  color: #e6edf3;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 5px;
  box-shadow: none;
  white-space: nowrap;
}
.ward-label-tooltip::before { display: none; }

/* ── Vega-Lite containers ── */
.vg { width: 100%; overflow: hidden; }

/* ── responsive ── */
@media (max-width: 720px) {
  .dash { grid-template-columns: 1fr; }
  .cell.wide { grid-column: 1; }
  header { padding: 14px 16px; }
  .controls, .kpis, .cell { padding: 12px 16px; }
}
</style>
</head>
<body>

<header>
  <h1>Hamilton Urban Forest — Climate Vulnerability Dashboard</h1>
  <p>HEAD 2026 &nbsp;·&nbsp; University of Niagara Falls Canada &nbsp;·&nbsp;
     15 wards · 275,187 trees · CMIP6 projections</p>
</header>

<div class="controls">
  <div class="ctrl">
    <label>Climate Scenario</label>
    <select id="sel-scenario">
      <option value="SSP5-8.5">SSP5-8.5 — High Emissions</option>
      <option value="SSP2-4.5">SSP2-4.5 — Low Emissions</option>
    </select>
  </div>
  <div class="ctrl">
    <label>Time Horizon</label>
    <div class="slider-wrap">
      <input type="range" id="slider" min="0" max="2" step="1" value="0"/>
      <div class="ticks"><span>2030</span><span>2050</span><span>2080</span></div>
    </div>
  </div>
  <div class="ctrl">
    <label>Map Metric</label>
    <select id="sel-metric">
      <option value="v_score">Vulnerability Score</option>
      <option value="e_norm">Exposure (normalised)</option>
      <option value="s_norm">Sensitivity (normalised)</option>
      <option value="ac_norm">Adaptive Capacity (normalised)</option>
    </select>
  </div>
</div>

<div class="kpis">
  <div class="kpi red">  <div class="num" id="k-maxward">—</div><div class="lbl">Most Vulnerable Ward</div></div>
  <div class="kpi red">  <div class="num" id="k-maxscore">—</div><div class="lbl">Highest V-Score</div></div>
  <div class="kpi green"><div class="num" id="k-minward">—</div><div class="lbl">Most Resilient Ward</div></div>
  <div class="kpi blue"> <div class="num" id="k-txx">—</div><div class="lbl">Peak Temp Change TXx</div></div>
  <div class="kpi gold"> <div class="num" id="k-precip">—</div><div class="lbl">Precip Change</div></div>
</div>

<div class="dash">

  <!-- MAP — full width, Leaflet -->
  <div class="cell wide">
    <h2>Ward Vulnerability Map</h2>
    <div id="map"></div>
  </div>

  <!-- BAR CHART -->
  <div class="cell">
    <h2>Vulnerability Score by Ward</h2>
    <div class="vg" id="vg-bar"></div>
  </div>

  <!-- TREND LINE -->
  <div class="cell">
    <h2>Peak Temperature Trend — TXx (both scenarios)</h2>
    <div class="vg" id="vg-trend"></div>
  </div>

  <!-- DECOMPOSITION -->
  <div class="cell">
    <h2>Score Decomposition — Exposure · Sensitivity · Adaptive Capacity</h2>
    <div class="vg" id="vg-decomp"></div>
  </div>

  <!-- SPECIES SCATTER -->
  <div class="cell">
    <h2>Species Risk — Fraxinus % vs Invasive % per Ward</h2>
    <div class="vg" id="vg-species"></div>
  </div>

  <!-- CANOPY -->
  <div class="cell">
    <h2>Canopy Cover % per Ward</h2>
    <div class="vg" id="vg-canopy"></div>
  </div>

  <!-- TREE COUNT -->
  <div class="cell">
    <h2>Tree Count per Ward</h2>
    <div class="vg" id="vg-trees"></div>
  </div>

</div><!-- .dash -->

<script>
/* ════ embedded project data ════ */

const WARD_GEO      = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"WARD":1},"geometry":{"type":"Polygon","coordinates":[[[-79.88746479639268,43.28941500553563],[-79.88619987594616,43.28895749678125],[-79.886754856027,43.28812316905699],[-79.8868186561751,43.286415919202135],[-79.88623789085234,43.284275787653435],[-79.88472339147044,43.28338049617608],[-79.88265643178207,43.283523297994094],[-79.88166244861515,43.284078117435286],[-79.8818900394873,43.28340124202108],[-79.88141935731272,43.282742087796436],[-79.88289097381792,43.281176801030945],[-79.88415110714229,43.28068441651019],[-79.88310227464073,43.28067830771027],[-79.88182805213945,43.28228525801739],[-79.87493038314611,43.28639367822622],[-79.87719420054415,43.28798847068561],[-79.88391233493977,43.28830788031726],[-79.88614653578121,43.28790644821393],[-79.8860815660266,43.28908627598594],[-79.88739330037751,43.28944110658557],[-79.88735647304414,43.29021004645664],[-79.89210541320037,43.29403734598323],[-79.89638023961764,43.29002185907965],[-79.89727915317974,43.28768565867586],[-79.89654959899815,43.28548151590838],[-79.89272682728974,43.28172713800914],[-79.89232096664773,43.279404341069586],[-79.89626563255368,43.27988809745443],[-79.89970725807021,43.272291960474334],[-79.93012731726981,43.267254309832204],[-79.92934322726563,43.2656610291641],[-79.92857953979819,43.26515687336975],[-79.92867724775503,43.26353929655252],[-79.93133884814402,43.26301600712333],[-79.93219176077706,43.26180160017465],[-79.93237980152222,43.26055928270924],[-79.93337422576197,43.26058656976104],[-79.93446340429787,43.25977280183056],[-79.93580628503632,43.25977629984736],[-79.93610277040258,43.25902339272563],[-79.93834715185115,43.258259317297586],[-79.93907580861577,43.25738443765667],[-79.93845536650352,43.25681733693158],[-79.93836647281628,43.25543133592233],[-79.93920514805036,43.2546676936815],[-79.9431427478083,43.25369040570232],[-79.9434527591078,43.25440688222316],[-79.94421775452227,43.2540387254029],[-79.94414302008053,43.25474192559335],[-79.94590412766918,43.25519038752732],[-79.94566589176088,43.254896265002714],[-79.94618670801314,43.254820833375334],[-79.9429280226076,43.24338991701544],[-79.93626782505626,43.24529518141963],[-79.93581706481973,43.24454135385698],[-79.93448572473774,43.24389485506705],[-79.93402553308904,43.2443265704647],[-79.93432460919658,43.24530113541656],[-79.929964458997,43.2459312723009],[-79.92901536913638,43.24514421314774],[-79.92613647167005,43.24582561358256],[-79.9162312395122,43.24552130333113],[-79.9153090398213,43.245255931746534],[-79.9148826841161,43.24453903805774],[-79.91427958487874,43.245308475341425],[-79.91033261838736,43.245427508683946],[-79.90771390087505,43.244178111261846],[-79.90755823990432,43.245079336696435],[-79.90632909666063,43.24510513940003],[-79.90538854259185,43.24409285080679],[-79.90310026047536,43.24359593638683],[-79.90354871563484,43.24474382137711],[-79.90156422128956,43.24476530084659],[-79.90036134298813,43.24298884166419],[-79.90095659094992,43.24207987591341],[-79.90067505983818,43.24169447388519],[-79.89917577522225,43.24275835607776],[-79.8996289995376,43.24467016162601],[-79.89782986446635,43.244938735588455],[-79.89554973995094,43.24489873316987],[-79.89110987145642,43.243907323476655],[-79.89120845347401,43.243565384238266],[-79.8905065332672,43.243386679808474],[-79.88677922732064,43.244075334621925],[-79.88581231308818,43.24346036074278],[-79.88440238389356,43.2434924526923],[-79.88424461817009,43.24420677852035],[-79.88480851942002,43.24443145701305],[-79.87432458716626,43.26976070355408],[-79.88202319137199,43.2712308389566],[-79.88398775299943,43.27205031942768],[-79.88604643830573,43.27377943838724],[-79.8892597749591,43.2784433502328],[-79.88950359838846,43.279448404992195],[-79.89025326944252,43.27967349823881],[-79.88918933626104,43.28147401346458],[-79.88971593856205,43.28202482907079],[-79.88988680082404,43.281004883385044],[-79.88971643712705,43.281391736316365],[-79.89038155605161,43.28218108866521],[-79.89042116726407,43.28540005504862],[-79.88746479639268,43.28941500553563]]]}},{"type":"Feature","properties":{"WARD":2},"geometry":{"type":"Polygon","coordinates":[[[-79.85492908971462,43.263906852982124],[-79.84983435207292,43.27553821437579],[-79.8545084275317,43.27652513728095],[-79.8524708014306,43.27596567599889],[-79.8530522162353,43.27461608127732],[-79.85616884475677,43.27546918579922],[-79.85553767586171,43.276760079753856],[-79.86149514741746,43.27817236622059],[-79.86219925681863,43.276622010251934],[-79.8604926994256,43.27622486992089],[-79.86006425962896,43.27488917209083],[-79.86054378931077,43.274924112824266],[-79.86061464123385,43.27546089331296],[-79.86135937694372,43.27428569812142],[-79.86119107308367,43.27499671960813],[-79.86169428954291,43.27432020687734],[-79.8634123013541,43.27495127178609],[-79.86306062439512,43.27425742960037],[-79.86360986064803,43.274173447403655],[-79.86366531544714,43.2748554053386],[-79.86434979486273,43.274844915194954],[-79.86500685500087,43.27416397091552],[-79.8665705380429,43.27378835833774],[-79.8678940214594,43.275572523595734],[-79.86838811373029,43.27550249635003],[-79.86742361237268,43.27441689891792],[-79.86751306930361,43.27380995248726],[-79.86861436521438,43.272775650440416],[-79.86925471489162,43.2732047482987],[-79.86945924960372,43.272909174445495],[-79.86746914527949,43.27242092146923],[-79.86739080410187,43.27150814608943],[-79.86823542797976,43.27121128396397],[-79.86809308453311,43.27065435092341],[-79.8690518537409,43.270667060444765],[-79.8695795124607,43.26985509715955],[-79.87044343035427,43.270339187825954],[-79.8701697253653,43.27156075925978],[-79.87113010435407,43.27278437104909],[-79.87578819878397,43.27335998013133],[-79.87442956878193,43.27174214709844],[-79.87506982593271,43.27124476428955],[-79.87677747837206,43.271337117487974],[-79.87134267000482,43.26981741613311],[-79.87183596996162,43.2691643064673],[-79.87432458716626,43.26976070355408],[-79.88480851942002,43.24443145701305],[-79.87796772097069,43.245055563151936],[-79.87515384625955,43.24495742021371],[-79.87489107556422,43.24460858659414],[-79.87377223106436,43.24515566639116],[-79.86218138483603,43.24633683803399],[-79.86035115368293,43.24698358834809],[-79.85938395827776,43.24792393257711],[-79.85860843460814,43.249700284487105],[-79.86000910935871,43.25185428462716],[-79.85492908971462,43.263906852982124]]]}},{"type":"Feature","properties":{"WARD":3},"geometry":{"type":"Polygon","coordinates":[[[-79.8075694363203,43.272639774784054],[-79.80758100931612,43.27358978153875],[-79.80479623103703,43.280426637177094],[-79.81093325336018,43.28183681582924],[-79.81132099049131,43.2817576304667],[-79.81141790793069,43.2808149050646],[-79.81157973583586,43.281918684302106],[-79.81364032018068,43.282474872069784],[-79.81566924340329,43.281681011165084],[-79.81644271532079,43.282381817727064],[-79.82360281275133,43.28384338893897],[-79.82368949478638,43.2846994944756],[-79.82598058683308,43.28519213488407],[-79.83324282271145,43.26973841462741],[-79.83400653353506,43.27023466574425],[-79.83390320481952,43.27126817048433],[-79.83761033101152,43.27208136942351],[-79.83735415035713,43.27286136782811],[-79.84025292843901,43.27348184106445],[-79.84168192527386,43.270344243273726],[-79.84275891367135,43.27042729475578],[-79.84136964033837,43.27370200717107],[-79.84434420029766,43.2743565717936],[-79.84577803545861,43.27095318258889],[-79.84648460265039,43.27110738017737],[-79.84503695499363,43.27450902427391],[-79.84910541323728,43.27538469578223],[-79.85094670804146,43.27096396119924],[-79.85166366155455,43.27112007521438],[-79.85224187566192,43.2701714048049],[-79.86000910935871,43.25185428462716],[-79.85990816567022,43.25115695282849],[-79.85860787675436,43.24979357462608],[-79.85999097776302,43.247252203803555],[-79.86197939505115,43.246368671310336],[-79.87377169027856,43.24515574229675],[-79.87489107556422,43.24460858659414],[-79.86475963593973,43.24535673678118],[-79.86056814982463,43.24471769461051],[-79.86032097118769,43.24399567478703],[-79.86164945283045,43.24376127789147],[-79.85993881978098,43.24312742654524],[-79.85920174939542,43.24456675500828],[-79.8542055407707,43.243711715600334],[-79.83833801849394,43.23927070324936],[-79.83325980536189,43.237265020522614],[-79.82979991619733,43.23469488070475],[-79.82398105199499,43.231913474454366],[-79.8075694363203,43.272639774784054]]]}},{"type":"Feature","properties":{"WARD":4},"geometry":{"type":"Polygon","coordinates":[[[-79.79409960647007,43.27472217599789],[-79.79465649367425,43.27499083326423],[-79.7973835992138,43.27385258285825],[-79.80039368305097,43.26689332664115],[-79.80137965594052,43.26672155114135],[-79.79661539411882,43.27833895455786],[-79.79719969521052,43.2788259599686],[-79.80387522880041,43.28004126723078],[-79.80700251762933,43.27259990632964],[-79.8075694363203,43.272639774784054],[-79.82398105199499,43.231913474454366],[-79.82084114363293,43.230453286741046],[-79.81696641786007,43.22974919023884],[-79.81587534118395,43.22917736110849],[-79.8156106166529,43.228488740160735],[-79.81557991493143,43.225940838239346],[-79.81662774131988,43.22025401380888],[-79.81621289213514,43.21512689975476],[-79.81688840636416,43.214733181670326],[-79.81629933342167,43.21437509841473],[-79.81678242672021,43.21294916898328],[-79.8163830887455,43.21280096396329],[-79.8159959067732,43.21430892368812],[-79.81542091402444,43.21258164548494],[-79.81508447249269,43.207970761111895],[-79.81585834236385,43.20561352483892],[-79.81640366914866,43.206167010088066],[-79.81672559660039,43.20554145737013],[-79.81917316349148,43.20527112781215],[-79.82039997920029,43.205965166087815],[-79.82019397664101,43.20654303060428],[-79.82063229071927,43.20668568134149],[-79.82035618094028,43.206538760171824],[-79.82079620451255,43.20590243685709],[-79.81951754972366,43.20454530641759],[-79.8164569994321,43.20388632646422],[-79.81701329913811,43.202278807757246],[-79.81824633208699,43.201313741336726],[-79.81967356642724,43.201184399919846],[-79.82003825638147,43.19988248780985],[-79.81707642105819,43.20065556335771],[-79.81492960653094,43.20261742626813],[-79.81298841906718,43.20253120598671],[-79.81079994786359,43.203091526611985],[-79.80943067731704,43.20521606739625],[-79.80456608715282,43.209565163342766],[-79.80074811963455,43.21732630572834],[-79.79644493250544,43.223218931171346],[-79.79457264492565,43.22452618145544],[-79.78931465465072,43.226513453748666],[-79.78547313240739,43.23158777357708],[-79.77931348960708,43.23419280304227],[-79.77459793623669,43.23806506336816],[-79.7696895091849,43.24492801976944],[-79.7680616810417,43.246310120421484],[-79.76727200351645,43.24906230992633],[-79.7648686490087,43.25101542879703],[-79.76491471731141,43.252164756033956],[-79.7666576178459,43.253517253660625],[-79.76652202523857,43.254547024432064],[-79.76739868483615,43.25634093398501],[-79.77012942495934,43.25822105272659],[-79.77088119986777,43.26087252864077],[-79.77350774170618,43.26341211961143],[-79.77556953428505,43.26268463730845],[-79.77787984309231,43.263366170553674],[-79.77888401045962,43.26645531297478],[-79.78149373224265,43.26852830910252],[-79.78294450693494,43.26823021056367],[-79.78568663500096,43.269090824078006],[-79.78817044891377,43.263132045759676],[-79.78920117766741,43.26305628285964],[-79.78668727198921,43.26931236594197],[-79.7892701548065,43.27087340223701],[-79.79074329934599,43.26729201272316],[-79.79208088810908,43.26709545232123],[-79.79232716034592,43.26665315622618],[-79.79225325774412,43.26710441773171],[-79.79267201549864,43.267032309132],[-79.7935651484019,43.265405391298096],[-79.79306916427902,43.26687237304288],[-79.79009070652974,43.26916796681564],[-79.78932885701538,43.27120619719244],[-79.79241241405964,43.27325105554787],[-79.79427193837587,43.26904599782124],[-79.79245874017884,43.273431953694015],[-79.79409960647007,43.27472217599789]]]}},{"type":"Feature","properties":{"WARD":5},"geometry":{"type":"Polygon","coordinates":[[[-79.73611549017559,43.244335627567615],[-79.7366811000212,43.245590130956614],[-79.7390612636216,43.245905382264205],[-79.74230976752169,43.24529103017672],[-79.7491590685252,43.247228872784234],[-79.75627499669154,43.251756130397034],[-79.76181103351321,43.25631885735195],[-79.77037649130686,43.26470842334922],[-79.77529618772388,43.27052878350903],[-79.78149312048994,43.27842902302825],[-79.7880131754671,43.28792877364365],[-79.79422876175006,43.29803541884069],[-79.79421447853703,43.29901709960417],[-79.79027345350292,43.30100815387242],[-79.79288548934615,43.299884967347936],[-79.7932054557756,43.300248982475374],[-79.79789106021273,43.29787191345839],[-79.79759244494095,43.2975096970765],[-79.79883047611607,43.296802705249526],[-79.79761466746444,43.29731519436677],[-79.79644903870461,43.29644501665443],[-79.79437409119672,43.292822510548305],[-79.7943298392875,43.29076673905449],[-79.79043325840209,43.28490436704056],[-79.79409417884914,43.283734431459195],[-79.7924655080862,43.280077167669745],[-79.7866499083616,43.273081008354],[-79.77936027476538,43.2670355692848],[-79.77810765405172,43.26355533854815],[-79.77556953428505,43.26268463730845],[-79.77350774170618,43.26341211961143],[-79.77088119986777,43.26087252864077],[-79.77012942495934,43.25822105272659],[-79.76739868483615,43.25634093398501],[-79.76652202523857,43.254547024432064],[-79.7666576178459,43.253517253660625],[-79.76491471731141,43.252164756033956],[-79.76482073556639,43.2512173068719],[-79.76727200351645,43.24906230992633],[-79.7680616810417,43.246310120421484],[-79.7696895091849,43.24492801976944],[-79.77459793623669,43.23806506336816],[-79.77931348960708,43.23419280304227],[-79.78547313240739,43.23158777357708],[-79.78931465465072,43.226513453748666],[-79.79457264492565,43.22452618145544],[-79.79647680203676,43.223185351123774],[-79.80074811963455,43.21732630572834],[-79.80456608715282,43.209565163342766],[-79.80979531067739,43.20480741500423],[-79.81078531700255,43.203105287452615],[-79.80981146148788,43.20328466134717],[-79.80972440216044,43.202539341426245],[-79.8109716464571,43.201758756643734],[-79.80977138045654,43.2019147285046],[-79.80893628411054,43.202816316350116],[-79.80550418432931,43.20400660036735],[-79.80025248046474,43.203852589094154],[-79.79653082581964,43.205183190498225],[-79.7935894514236,43.20494015103245],[-79.78928894307067,43.20537898162601],[-79.78909027705231,43.205048659566174],[-79.7903243906745,43.20392317084907],[-79.78991283022201,43.20349659102907],[-79.78733831161834,43.204629934667565],[-79.78745921227915,43.20584684270977],[-79.7806905943612,43.208301143300034],[-79.77522543820874,43.209091263901364],[-79.77410054894533,43.20870894402832],[-79.77379694982034,43.209257043418624],[-79.76958806693143,43.209874137452495],[-79.76870345275204,43.20863098614816],[-79.76710923148192,43.2082606545742],[-79.7667684205446,43.20718245672321],[-79.7660779628408,43.207169969014004],[-79.76460586034706,43.20508805758117],[-79.76440437451704,43.20565416199328],[-79.76565651822527,43.207515610209605],[-79.76583286560037,43.20861103522662],[-79.76327418878674,43.20919571676315],[-79.76295513414726,43.20968752121633],[-79.76712329909928,43.210342853185736],[-79.75854188093798,43.21126954556105],[-79.75778313240798,43.210573985155634],[-79.75595477693716,43.2103489906492],[-79.75577951832018,43.21096444009409],[-79.75694330194044,43.21151331797463],[-79.74897104754297,43.21153247900936],[-79.73518648305148,43.244151152548866],[-79.73611549017559,43.244335627567615]]]}},{"type":"Feature","properties":{"WARD":6},"geometry":{"type":"Polygon","coordinates":[[[-79.81668602311719,43.201004238634546],[-79.82003825638147,43.19988248780985],[-79.81967356642724,43.201184399919846],[-79.81824633208699,43.201313741336726],[-79.81701329913811,43.202278807757246],[-79.8164569994321,43.20388632646422],[-79.81710832203056,43.20431105964956],[-79.81901328223555,43.20425573251917],[-79.8208292858712,43.20599354423054],[-79.82054518467945,43.20673430861202],[-79.82019397664101,43.20654303060428],[-79.82039997920029,43.205965166087815],[-79.81917316349148,43.20527112781215],[-79.81672559660039,43.20554145737013],[-79.81640366914866,43.206167010088066],[-79.81585834236385,43.20561352483892],[-79.81508447249269,43.207970761111895],[-79.81542091402444,43.21258164548494],[-79.8159959067732,43.21430892368812],[-79.8163830887455,43.21280096396329],[-79.81678242672021,43.21294916898328],[-79.81629933342167,43.21437509841473],[-79.81688840636416,43.214733181670326],[-79.81621289213514,43.21512689975476],[-79.81666582898958,43.21929694470092],[-79.81634953846626,43.22339455532393],[-79.81557991493143,43.225940838239346],[-79.81571416904896,43.228966335553245],[-79.81717229555352,43.22982029247917],[-79.82131318585688,43.230611949896335],[-79.82574923740977,43.23293051869618],[-79.82717029673074,43.23321217459502],[-79.83325980536189,43.237265020522614],[-79.83478032794775,43.237802861468495],[-79.8470580188558,43.209066929603786],[-79.8563295946836,43.21135579604893],[-79.86361873869797,43.195224460306996],[-79.85970372348461,43.19424523655103],[-79.86217624647263,43.18879334944577],[-79.82875652029988,43.1809384813419],[-79.82165039904149,43.178808851044174],[-79.81966135203433,43.18326228481953],[-79.82113665253048,43.18414503758149],[-79.81781346179935,43.18710892600536],[-79.81495371012664,43.193416695671154],[-79.81213929642635,43.19633091029224],[-79.81241199709883,43.19888196431668],[-79.81078531700255,43.203105287452615],[-79.81298841906718,43.20253120598671],[-79.81492960653094,43.20261742626813],[-79.81668602311719,43.201004238634546]]]}},{"type":"Feature","properties":{"WARD":7},"geometry":{"type":"Polygon","coordinates":[[[-79.8470580188558,43.209066929603786],[-79.83478032794775,43.237802861468495],[-79.84062132933367,43.239993257447644],[-79.8431447293061,43.24033918966179],[-79.8542055407707,43.243711715600334],[-79.85920174939542,43.24456675500828],[-79.85993881978098,43.24312742654524],[-79.86164945283045,43.24376127789147],[-79.86032097118769,43.24399567478703],[-79.86056814982463,43.24471769461051],[-79.86395520538258,43.24501026703491],[-79.8753848210854,43.217405380467895],[-79.885778495111,43.194475219909116],[-79.86217624647263,43.18879334944577],[-79.85970372348461,43.19424523655103],[-79.86361873869797,43.195224460306996],[-79.8563295946836,43.21135579604893],[-79.8470580188558,43.209066929603786]]]}},{"type":"Feature","properties":{"WARD":8},"geometry":{"type":"Polygon","coordinates":[[[-79.885778495111,43.194475219909116],[-79.8753848210854,43.217405380467895],[-79.86395520538258,43.24501026703491],[-79.86441658101083,43.245317312434366],[-79.87275836458694,43.24505539825328],[-79.8747069811181,43.2445350320324],[-79.87613381121648,43.245032335334535],[-79.88249819713803,43.24478925641717],[-79.88472857834289,43.2443480082018],[-79.88424461817009,43.24420677852035],[-79.88459469073801,43.243416258987295],[-79.88581231308818,43.24346036074278],[-79.88677922732064,43.244075334621925],[-79.8905065332672,43.243386679808474],[-79.89120845347401,43.243565384238266],[-79.89110987145642,43.243907323476655],[-79.89558704967963,43.24470854791657],[-79.912514716044,43.20654171712878],[-79.91451481143083,43.20486385412502],[-79.91514899327535,43.20368302845527],[-79.91506950944068,43.20146326820924],[-79.885778495111,43.194475219909116]]]}},{"type":"Feature","properties":{"WARD":9},"geometry":{"type":"Polygon","coordinates":[[[-79.64302395942791,43.19501486672455],[-79.64447309379648,43.194539765800144],[-79.64693045142585,43.19516019347073],[-79.64875844038401,43.19641147198568],[-79.6502220744596,43.196210572141005],[-79.65072401620942,43.19763327735309],[-79.65269427944399,43.198460884781205],[-79.65979361932031,43.19975990595628],[-79.6608999646613,43.20038715833204],[-79.66431481499245,43.200642204034324],[-79.66570041960581,43.20031917220197],[-79.67838846093564,43.202569588698125],[-79.6958766347148,43.20315048113526],[-79.70684431244399,43.20469376460479],[-79.72887447250424,43.20862457482581],[-79.73812319339457,43.21136235832482],[-79.7557101656853,43.211681085180615],[-79.75697520291281,43.2114276713623],[-79.75577951832018,43.21096444009409],[-79.75595477693716,43.2103489906492],[-79.75778313240798,43.210573985155634],[-79.75854188093798,43.21126954556105],[-79.76712329909928,43.210342853185736],[-79.76295513414726,43.20968752121633],[-79.76327418878674,43.20919571676315],[-79.76583286560037,43.20861103522662],[-79.76565651822527,43.207515610209605],[-79.76440437451704,43.20565416199328],[-79.76460586034706,43.20508805758117],[-79.7660779628408,43.207169969014004],[-79.7667684205446,43.20718245672321],[-79.76710923148192,43.2082606545742],[-79.76870345275204,43.20863098614816],[-79.76958806693143,43.209874137452495],[-79.77379694982034,43.209257043418624],[-79.77410054894533,43.20870894402832],[-79.77522543820874,43.209091263901364],[-79.7806905943612,43.208301143300034],[-79.78745921227915,43.20584684270977],[-79.78733831161834,43.204629934667565],[-79.78991283022201,43.20349659102907],[-79.7903243906745,43.20392317084907],[-79.78909027705231,43.205048659566174],[-79.78941876400226,43.20538134605796],[-79.7935894514236,43.20494015103245],[-79.79667056055871,43.20516971430435],[-79.80025248046474,43.203852589094154],[-79.80540392515707,43.204028606903826],[-79.80893628411054,43.202816316350116],[-79.80977138045654,43.2019147285046],[-79.8109716464571,43.201758756643734],[-79.80969500569108,43.2026268313834],[-79.8097265697952,43.20321921452162],[-79.810565691492,43.20332024035154],[-79.81241199709883,43.19888196431668],[-79.81231494401385,43.19590212870112],[-79.81495371012664,43.193416695671154],[-79.81792840034164,43.18695571700869],[-79.82113665253048,43.18414503758149],[-79.81966135203433,43.18326228481953],[-79.82165039904149,43.178808851044174],[-79.79814865661206,43.17158683029706],[-79.76108602121371,43.162109004646965],[-79.72377626736555,43.151482985303666],[-79.71526876348413,43.14963515357925],[-79.71320926160924,43.14767191612731],[-79.70977134254157,43.15581298795898],[-79.65839253314134,43.14409271078674],[-79.63583556686253,43.195121527767256],[-79.63790700465258,43.19445078154564],[-79.64302395942791,43.19501486672455]]]}},{"type":"Feature","properties":{"WARD":10},"geometry":{"type":"Polygon","coordinates":[[[-79.72646057896156,43.24396475508211],[-79.7281728909623,43.24410570721732],[-79.73257363153799,43.24568872307044],[-79.73643435616884,43.24551515762974],[-79.7363457454509,43.24438040069263],[-79.73518648305148,43.244151152548866],[-79.74897104754297,43.21153247900936],[-79.73812319339457,43.21136235832482],[-79.72898469848454,43.208651822940986],[-79.7208527029683,43.20697231165053],[-79.6958766347148,43.20315048113526],[-79.68097090717171,43.202808484780995],[-79.66570041960581,43.20031917220197],[-79.66431481499245,43.200642204034324],[-79.6608999646613,43.20038715833204],[-79.65979361932031,43.19975990595628],[-79.65269427944399,43.198460884781205],[-79.65072401620942,43.19763327735309],[-79.6502220744596,43.196210572141005],[-79.64875844038401,43.19641147198568],[-79.64693045142585,43.19516019347073],[-79.64528300048357,43.19470847231849],[-79.64201330173266,43.1950799523344],[-79.63790700465258,43.19445078154564],[-79.63583556686253,43.195121527767256],[-79.6221807801835,43.22629131957388],[-79.6225362237785,43.22589853629553],[-79.62796312337795,43.228482191509514],[-79.62946731549029,43.228636511057374],[-79.6489675124866,43.22343419939775],[-79.65480791649286,43.22268701853028],[-79.66636408595457,43.22613246385743],[-79.67154072659399,43.22911731183986],[-79.67368665987392,43.23086428258497],[-79.6752519203576,43.230912515541334],[-79.682081002979,43.23403305950274],[-79.68655783804579,43.23403702760438],[-79.6897569417918,43.23620951694381],[-79.68950136839851,43.235334453408605],[-79.69017667062515,43.23400204246031],[-79.69007443336267,43.23555309252318],[-79.6908392841484,43.23534043848438],[-79.69368080271576,43.23608170242175],[-79.69676756584728,43.235456583523835],[-79.70295448419456,43.235891687944985],[-79.7066794608096,43.23553157511932],[-79.71610593583677,43.238517115921624],[-79.72085863454414,43.24106078165052],[-79.72132110162545,43.2408036714839],[-79.721076420305,43.24119280465438],[-79.72646057896156,43.24396475508211]]]}},{"type":"Feature","properties":{"WARD":11},"geometry":{"type":"Polygon","coordinates":[[[-79.94088340851192,43.17989399804465],[-79.96494093681102,43.12512654787546],[-79.75410311108304,43.050520592947905],[-79.71320926160924,43.14767191612731],[-79.71526876348413,43.14963515357925],[-79.72377626736555,43.151482985303666],[-79.76108602121371,43.162109004646965],[-79.79814865661206,43.17158683029706],[-79.82875652029988,43.1809384813419],[-79.92988388999747,43.20484635351128],[-79.94088340851192,43.17989399804465]]]}},{"type":"Feature","properties":{"WARD":12},"geometry":{"type":"Polygon","coordinates":[[[-80.06405982624693,43.28107005966739],[-80.06752109522377,43.280360108427736],[-80.06868442249986,43.28153280259389],[-80.0887061732653,43.287860986494046],[-80.09288946854166,43.28966913017047],[-80.11263821949564,43.29625834840935],[-80.12763843633188,43.299051064117414],[-80.13712098869067,43.30424352473676],[-80.17270853739187,43.31604434965883],[-80.19721646480475,43.32259726677806],[-80.20692769050564,43.327378345452885],[-80.22111378486112,43.32917967139068],[-80.2375624228036,43.33535295408076],[-80.24857500821219,43.33349536781748],[-80.21450797131708,43.24489837785157],[-80.20042905405978,43.21063936974812],[-80.17033831724336,43.19921348212888],[-80.08602960963862,43.16920547161795],[-80.04635425567744,43.154388671080554],[-79.96494093681102,43.12512654787546],[-79.92876727601448,43.20733746072529],[-79.92893061039439,43.210342493737485],[-79.92752877322384,43.21037259964658],[-79.92351747298505,43.2195515931906],[-79.9291823893039,43.2206625967518],[-79.9298105515377,43.22399433716917],[-79.92998730764624,43.229215619708754],[-79.9505040975069,43.232239348996416],[-79.9486501993393,43.23502886166308],[-79.94846731941544,43.239218022253574],[-79.94789195206921,43.2408035746319],[-79.94599067585521,43.242456530919995],[-79.9429280226076,43.24338991701544],[-79.946411146697,43.25495796768256],[-79.94787902890555,43.254850639262315],[-79.94990674928398,43.25562268758397],[-79.95174628069526,43.25479988085588],[-79.95321019145193,43.25492359384762],[-79.95705463501659,43.25325684357801],[-79.95801562845301,43.251741574452154],[-79.96162769043009,43.250747087076654],[-79.96256646493627,43.24950846797572],[-79.9657995887804,43.248809183001846],[-79.96795613745206,43.24766553420491],[-79.97094501565864,43.247928835464656],[-79.97239815022517,43.24715471612431],[-79.97419432714419,43.248089307483475],[-79.97554818978699,43.24803246604438],[-79.97701464816582,43.2486743818984],[-79.9776320791252,43.248400385011266],[-79.97841019443442,43.25082526133239],[-79.9898568942973,43.246868964374706],[-79.99245669059478,43.25499736354493],[-79.99721552030397,43.253991809465916],[-80.00196335822736,43.25371563096622],[-80.00525014473162,43.252431222228374],[-80.01213400751736,43.251078037681964],[-80.0192957785093,43.24875703698158],[-80.0263334454481,43.24740673690113],[-80.02725065589591,43.25000249970915],[-80.02670849387584,43.25070566864315],[-80.02741237510492,43.25098284943425],[-80.02708380730661,43.25308559358555],[-80.02859742094964,43.25444696541404],[-80.03275903089502,43.26868446534089],[-80.04146930789224,43.274247164345546],[-80.04482486492307,43.27550886466655],[-80.06025608175455,43.27876830029366],[-80.06332717557257,43.279748810132396],[-80.06405982624693,43.28107005966739]]]}},{"type":"Feature","properties":{"WARD":13},"geometry":{"type":"Polygon","coordinates":[[[-79.96515539611038,43.34683873733757],[-80.02837022803114,43.39368118210032],[-80.0340002753439,43.398897401441715],[-80.04671240320143,43.40776129180704],[-80.04934826595925,43.40934810476729],[-80.05602942300281,43.41142736557258],[-80.06370008870489,43.41852184980153],[-80.07228293339087,43.422807915307565],[-80.08107328172095,43.42637690410124],[-80.07855606844586,43.41806201560901],[-80.20643172255242,43.39719319602544],[-80.203430094557,43.38813566980171],[-80.20277764457289,43.38806238016323],[-80.1999469794508,43.37928432165093],[-80.19752602604828,43.37047307554919],[-80.19810150209065,43.37018815633082],[-80.18928657854936,43.34351442821847],[-80.2375624228036,43.33535295408076],[-80.22111378486112,43.32917967139068],[-80.2165555273953,43.328324171817584],[-80.20907999014601,43.327856443471994],[-80.20620692903405,43.32715624590937],[-80.19721646480475,43.32259726677806],[-80.17270853739187,43.31604434965883],[-80.1358656523699,43.30379489338363],[-80.12998975682513,43.300061455741826],[-80.12742843447296,43.29898543964756],[-80.11263821949564,43.29625834840935],[-80.09288946854166,43.28966913017047],[-80.0887061732653,43.287860986494046],[-80.06868442249986,43.28153280259389],[-80.06752109522377,43.280360108427736],[-80.06405982624693,43.28107005966739],[-80.06332717557257,43.279748810132396],[-80.06025608175455,43.27876830029366],[-80.04482486492307,43.27550886466655],[-80.04124486112357,43.274155238077576],[-80.03275903089502,43.26868446534089],[-80.02859742094964,43.25444696541404],[-80.02708380730661,43.25308559358555],[-80.02741237510492,43.25098284943425],[-80.02670849387584,43.25070566864315],[-80.02725065589591,43.25000249970915],[-80.0263334454481,43.24740673690113],[-80.0192957785093,43.24875703698158],[-80.01213400751736,43.251078037681964],[-80.00525014473162,43.252431222228374],[-80.00196335822736,43.25371563096622],[-79.99721552030397,43.253991809465916],[-79.99245669059478,43.25499736354493],[-79.9898568942973,43.246868964374706],[-79.97841019443442,43.25082526133239],[-79.9776320791252,43.248400385011266],[-79.97701464816582,43.2486743818984],[-79.97554818978699,43.24803246604438],[-79.97419432714419,43.248089307483475],[-79.97239815022517,43.24715471612431],[-79.97094501565864,43.247928835464656],[-79.96795613745206,43.24766553420491],[-79.9657995887804,43.248809183001846],[-79.96256646493627,43.24950846797572],[-79.96162769043009,43.250747087076654],[-79.95801562845301,43.251741574452154],[-79.95705463501659,43.25325684357801],[-79.95310814642892,43.254947422423555],[-79.95174628069526,43.25479988085588],[-79.94990674928398,43.25562268758397],[-79.94787902890555,43.254850639262315],[-79.9457693884614,43.25484544120879],[-79.94583221124248,43.25519575958213],[-79.94414302008053,43.25474192559335],[-79.94421775452227,43.2540387254029],[-79.9434527591078,43.25440688222316],[-79.9431427478083,43.25369040570232],[-79.93939178742369,43.25456136903535],[-79.93836647281628,43.25543133592233],[-79.93845536650352,43.25681733693158],[-79.93907580861577,43.25738443765667],[-79.93834715185115,43.258259317297586],[-79.93610277040258,43.25902339272563],[-79.93580628503632,43.25977629984736],[-79.93446340429787,43.25977280183056],[-79.93337422576197,43.26058656976104],[-79.93237980152222,43.26055928270924],[-79.93219176077706,43.26180160017465],[-79.93133884814402,43.26301600712333],[-79.92867724775503,43.26353929655252],[-79.92857953979819,43.26515687336975],[-79.92934322726563,43.2656610291641],[-79.93012731726981,43.267254309832204],[-79.89970725807021,43.272291960474334],[-79.89626563255368,43.27988809745443],[-79.89232096664773,43.279404341069586],[-79.89226604814284,43.27989700539178],[-79.89278075585119,43.281811761783935],[-79.89654959899815,43.28548151590838],[-79.89727915317974,43.28768565867586],[-79.89638023961764,43.29002185907965],[-79.89210541320037,43.29403734598323],[-79.91171064750793,43.30788150692762],[-79.91828863034617,43.30431822766621],[-79.9220157296802,43.30100200265792],[-79.92427531062336,43.29987970384042],[-79.92741550195471,43.29908978420161],[-79.93156295714617,43.29903936996068],[-79.93182371471696,43.29854347471268],[-79.93384493308939,43.298406208463184],[-79.93543630849665,43.30348472256674],[-79.94751969919864,43.30142916834534],[-79.95657448100565,43.331202129688435],[-79.96073870774345,43.33386639263591],[-79.964380690806,43.346264799697856],[-79.96515539611038,43.34683873733757]]]}},{"type":"Feature","properties":{"WARD":14},"geometry":{"type":"Polygon","coordinates":[[[-79.94844228875836,43.23614019376882],[-79.94896857934398,43.234239380812426],[-79.95050409481195,43.232239348996416],[-79.92998730764624,43.229215619708754],[-79.9298105515377,43.22399433716917],[-79.9291823893039,43.2206625967518],[-79.92351747298505,43.2195515931906],[-79.92752877322384,43.21037259964658],[-79.92893061039439,43.210342493737485],[-79.9285907013656,43.207867801622456],[-79.92988388999747,43.20484635351128],[-79.91506950944068,43.20146327017372],[-79.91539157343635,43.202871329820994],[-79.9148422536401,43.204362683853844],[-79.9125147142474,43.20654171712878],[-79.89548123891896,43.244831346323394],[-79.8996289995376,43.24467016162601],[-79.89917577522225,43.24275835607776],[-79.90067505983818,43.24169447388519],[-79.90095659094992,43.24207987591341],[-79.90036134298813,43.24298884166419],[-79.90156422128956,43.24476530084659],[-79.90354871563484,43.24474382137711],[-79.90310026047536,43.24359593638683],[-79.90538854259185,43.24409285080679],[-79.90632909666063,43.24510513940003],[-79.90755823990432,43.245079336696435],[-79.90771390087505,43.244178111261846],[-79.91033261838736,43.245427508683946],[-79.91427958487874,43.245308475341425],[-79.9148826841161,43.24453903805774],[-79.9153090398213,43.245255931746534],[-79.9162312395122,43.24552130333113],[-79.92613647167005,43.24582561358256],[-79.92901536913638,43.24514421314774],[-79.929964458997,43.2459312723009],[-79.93432460919658,43.24530113541656],[-79.93402553308904,43.2443265704647],[-79.93448572473774,43.24389485506705],[-79.93581706481973,43.24454135385698],[-79.93626782505626,43.24529518141963],[-79.9452071652644,43.2428072575622],[-79.94680026633537,43.24194517640013],[-79.94830309480508,43.23999396879594],[-79.94844228875836,43.23614019376882]]]}},{"type":"Feature","properties":{"WARD":15},"geometry":{"type":"Polygon","coordinates":[[[-79.91193279189454,43.309006072043836],[-79.8844173444363,43.329194044143776],[-79.88280738647906,43.328232131891006],[-79.88153081578162,43.32849706266173],[-79.88120929347008,43.328170689090015],[-79.87612947954017,43.32931658520318],[-79.8737733566534,43.33060069122191],[-79.86818951957716,43.335585603942256],[-79.86793099521819,43.336514945872224],[-79.86624561111641,43.33724935962749],[-79.86126777932748,43.34167422170949],[-79.85993733396751,43.345726936505265],[-79.86000896922152,43.34697908278262],[-79.86056345522897,43.347408356732224],[-79.91315722077962,43.38497751080722],[-79.97789905752934,43.43036122015646],[-80.03383682238639,43.47070834778475],[-80.0837351507062,43.43515616148083],[-80.081235115016,43.42644285803993],[-80.07228293339087,43.422807915307565],[-80.06370008870489,43.41852184980153],[-80.05602942300281,43.41142736557258],[-80.04934826595925,43.40934810476729],[-80.04671240320143,43.40776129180704],[-80.0340002753439,43.398897401441715],[-80.02837022803114,43.39368118210032],[-79.964380690806,43.346264799697856],[-79.96073870774345,43.33386639263591],[-79.95657448100565,43.331202129688435],[-79.94751969919864,43.30142916834534],[-79.93543630849665,43.30348472256674],[-79.93384493308939,43.298406208463184],[-79.93182371471696,43.29854347471268],[-79.93156295714617,43.29903936996068],[-79.92708670239105,43.29915279475239],[-79.9220157296802,43.30100200265792],[-79.91828863034617,43.30431822766621],[-79.91171064750793,43.30788150692762],[-79.91259101175773,43.30850139290932],[-79.91193279189454,43.309006072043836]]]}}]};
const VULN_DATA     = [{"ward":1,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.1834,"e_norm":0.1513,"s_norm":0.8362,"ac_norm":0.6798},{"ward":2,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.4665,"e_norm":0.2098,"s_norm":0.754,"ac_norm":0.3291},{"ward":3,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.7597,"e_norm":0.2055,"s_norm":1.0,"ac_norm":0.2605},{"ward":4,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.3374,"e_norm":0.1991,"s_norm":0.8159,"ac_norm":0.4714},{"ward":5,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.2489,"e_norm":0.1863,"s_norm":0.638,"ac_norm":0.4676},{"ward":6,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.3504,"e_norm":0.2077,"s_norm":0.4828,"ac_norm":0.2762},{"ward":7,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.785,"e_norm":0.2162,"s_norm":0.3994,"ac_norm":0.1},{"ward":8,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.6202,"e_norm":0.2564,"s_norm":0.2859,"ac_norm":0.1082},{"ward":9,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.2131,"e_norm":0.2333,"s_norm":0.2665,"ac_norm":0.2818},{"ward":10,"scenario":"SSP5-8.5","horizon":2030,"v_score":1.3285,"e_norm":0.2226,"s_norm":0.7126,"ac_norm":0.1094},{"ward":11,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.0429,"e_norm":0.2162,"s_norm":0.1,"ac_norm":0.4935},{"ward":12,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.2232,"e_norm":0.1991,"s_norm":0.2913,"ac_norm":0.2499},{"ward":13,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.0397,"e_norm":0.1167,"s_norm":0.3436,"ac_norm":1.0},{"ward":14,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.2573,"e_norm":0.165,"s_norm":0.4693,"ac_norm":0.2909},{"ward":15,"scenario":"SSP5-8.5","horizon":2030,"v_score":0.3193,"e_norm":0.1846,"s_norm":0.9691,"ac_norm":0.5503},{"ward":1,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.4101,"e_norm":0.3383,"s_norm":0.8362,"ac_norm":0.6798},{"ward":2,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.9663,"e_norm":0.4346,"s_norm":0.754,"ac_norm":0.3291},{"ward":3,"scenario":"SSP5-8.5","horizon":2050,"v_score":1.5808,"e_norm":0.4276,"s_norm":1.0,"ac_norm":0.2605},{"ward":4,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.7069,"e_norm":0.4171,"s_norm":0.8159,"ac_norm":0.4714},{"ward":5,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.529,"e_norm":0.396,"s_norm":0.638,"ac_norm":0.4676},{"ward":6,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.7272,"e_norm":0.4311,"s_norm":0.4828,"ac_norm":0.2762},{"ward":7,"scenario":"SSP5-8.5","horizon":2050,"v_score":1.6165,"e_norm":0.4452,"s_norm":0.3994,"ac_norm":0.1},{"ward":8,"scenario":"SSP5-8.5","horizon":2050,"v_score":1.2367,"e_norm":0.5113,"s_norm":0.2859,"ac_norm":0.1082},{"ward":9,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.4323,"e_norm":0.4733,"s_norm":0.2665,"ac_norm":0.2818},{"ward":10,"scenario":"SSP5-8.5","horizon":2050,"v_score":2.7197,"e_norm":0.4557,"s_norm":0.7126,"ac_norm":0.1094},{"ward":11,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.0884,"e_norm":0.4452,"s_norm":0.1,"ac_norm":0.4935},{"ward":12,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.4675,"e_norm":0.4171,"s_norm":0.2913,"ac_norm":0.2499},{"ward":13,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.0957,"e_norm":0.2814,"s_norm":0.3436,"ac_norm":1.0},{"ward":14,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.5627,"e_norm":0.3608,"s_norm":0.4693,"ac_norm":0.2909},{"ward":15,"scenario":"SSP5-8.5","horizon":2050,"v_score":0.6801,"e_norm":0.3932,"s_norm":0.9691,"ac_norm":0.5503},{"ward":1,"scenario":"SSP5-8.5","horizon":2080,"v_score":0.8448,"e_norm":0.6969,"s_norm":0.8362,"ac_norm":0.6798},{"ward":2,"scenario":"SSP5-8.5","horizon":2080,"v_score":1.9249,"e_norm":0.8657,"s_norm":0.754,"ac_norm":0.3291},{"ward":3,"scenario":"SSP5-8.5","horizon":2080,"v_score":3.1549,"e_norm":0.8534,"s_norm":1.0,"ac_norm":0.2605},{"ward":4,"scenario":"SSP5-8.5","horizon":2080,"v_score":1.415,"e_norm":0.8349,"s_norm":0.8159,"ac_norm":0.4714},{"ward":5,"scenario":"SSP5-8.5","horizon":2080,"v_score":1.066,"e_norm":0.798,"s_norm":0.638,"ac_norm":0.4676},{"ward":6,"scenario":"SSP5-8.5","horizon":2080,"v_score":1.4501,"e_norm":0.8596,"s_norm":0.4828,"ac_norm":0.2762},{"ward":7,"scenario":"SSP5-8.5","horizon":2080,"v_score":3.2104,"e_norm":0.8842,"s_norm":0.3994,"ac_norm":0.1},{"ward":8,"scenario":"SSP5-8.5","horizon":2080,"v_score":2.4188,"e_norm":1.0,"s_norm":0.2859,"ac_norm":0.1082},{"ward":9,"scenario":"SSP5-8.5","horizon":2080,"v_score":0.8526,"e_norm":0.9335,"s_norm":0.2665,"ac_norm":0.2818},{"ward":10,"scenario":"SSP5-8.5","horizon":2080,"v_score":5.3875,"e_norm":0.9027,"s_norm":0.7126,"ac_norm":0.1094},{"ward":11,"scenario":"SSP5-8.5","horizon":2080,"v_score":0.1756,"e_norm":0.8842,"s_norm":0.1,"ac_norm":0.4935},{"ward":12,"scenario":"SSP5-8.5","horizon":2080,"v_score":0.9358,"e_norm":0.8349,"s_norm":0.2913,"ac_norm":0.2499},{"ward":13,"scenario":"SSP5-8.5","horizon":2080,"v_score":0.2031,"e_norm":0.5971,"s_norm":0.3436,"ac_norm":1.0},{"ward":14,"scenario":"SSP5-8.5","horizon":2080,"v_score":1.1485,"e_norm":0.7364,"s_norm":0.4693,"ac_norm":0.2909},{"ward":15,"scenario":"SSP5-8.5","horizon":2080,"v_score":1.3716,"e_norm":0.793,"s_norm":0.9691,"ac_norm":0.5503},{"ward":1,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.1604,"e_norm":0.1323,"s_norm":0.8362,"ac_norm":0.6798},{"ward":2,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.4158,"e_norm":0.187,"s_norm":0.754,"ac_norm":0.3291},{"ward":3,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.6765,"e_norm":0.183,"s_norm":1.0,"ac_norm":0.2605},{"ward":4,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.3002,"e_norm":0.1771,"s_norm":0.8159,"ac_norm":0.4714},{"ward":5,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.2205,"e_norm":0.1651,"s_norm":0.638,"ac_norm":0.4676},{"ward":6,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.3121,"e_norm":0.185,"s_norm":0.4828,"ac_norm":0.2762},{"ward":7,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.7008,"e_norm":0.193,"s_norm":0.3994,"ac_norm":0.1},{"ward":8,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.5575,"e_norm":0.2305,"s_norm":0.2859,"ac_norm":0.1082},{"ward":9,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.1909,"e_norm":0.209,"s_norm":0.2665,"ac_norm":0.2818},{"ward":10,"scenario":"SSP2-4.5","horizon":2030,"v_score":1.1877,"e_norm":0.199,"s_norm":0.7126,"ac_norm":0.1094},{"ward":11,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.0383,"e_norm":0.193,"s_norm":0.1,"ac_norm":0.4935},{"ward":12,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.1985,"e_norm":0.1771,"s_norm":0.2913,"ac_norm":0.2499},{"ward":13,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.034,"e_norm":0.1,"s_norm":0.3436,"ac_norm":1.0},{"ward":14,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.2263,"e_norm":0.1451,"s_norm":0.4693,"ac_norm":0.2909},{"ward":15,"scenario":"SSP2-4.5","horizon":2030,"v_score":0.2828,"e_norm":0.1635,"s_norm":0.9691,"ac_norm":0.5503},{"ward":1,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.306,"e_norm":0.2524,"s_norm":0.8362,"ac_norm":0.6798},{"ward":2,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.7367,"e_norm":0.3313,"s_norm":0.754,"ac_norm":0.3291},{"ward":3,"scenario":"SSP2-4.5","horizon":2050,"v_score":1.2037,"e_norm":0.3256,"s_norm":1.0,"ac_norm":0.2605},{"ward":4,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.5371,"e_norm":0.3169,"s_norm":0.8159,"ac_norm":0.4714},{"ward":5,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.4002,"e_norm":0.2996,"s_norm":0.638,"ac_norm":0.4676},{"ward":6,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.554,"e_norm":0.3284,"s_norm":0.4828,"ac_norm":0.2762},{"ward":7,"scenario":"SSP2-4.5","horizon":2050,"v_score":1.2345,"e_norm":0.34,"s_norm":0.3994,"ac_norm":0.1},{"ward":8,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.9532,"e_norm":0.3941,"s_norm":0.2859,"ac_norm":0.1082},{"ward":9,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.3315,"e_norm":0.363,"s_norm":0.2665,"ac_norm":0.2818},{"ward":10,"scenario":"SSP2-4.5","horizon":2050,"v_score":2.0805,"e_norm":0.3486,"s_norm":0.7126,"ac_norm":0.1094},{"ward":11,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.0675,"e_norm":0.34,"s_norm":0.1,"ac_norm":0.4935},{"ward":12,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.3552,"e_norm":0.3169,"s_norm":0.2913,"ac_norm":0.2499},{"ward":13,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.07,"e_norm":0.2057,"s_norm":0.3436,"ac_norm":1.0},{"ward":14,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.4224,"e_norm":0.2708,"s_norm":0.4693,"ac_norm":0.2909},{"ward":15,"scenario":"SSP2-4.5","horizon":2050,"v_score":0.5142,"e_norm":0.2973,"s_norm":0.9691,"ac_norm":0.5503},{"ward":1,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.4953,"e_norm":0.4086,"s_norm":0.8362,"ac_norm":0.6798},{"ward":2,"scenario":"SSP2-4.5","horizon":2080,"v_score":1.1545,"e_norm":0.5192,"s_norm":0.754,"ac_norm":0.3291},{"ward":3,"scenario":"SSP2-4.5","horizon":2080,"v_score":1.8895,"e_norm":0.5111,"s_norm":1.0,"ac_norm":0.2605},{"ward":4,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.8457,"e_norm":0.499,"s_norm":0.8159,"ac_norm":0.4714},{"ward":5,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.6343,"e_norm":0.4748,"s_norm":0.638,"ac_norm":0.4676},{"ward":6,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.8689,"e_norm":0.5151,"s_norm":0.4828,"ac_norm":0.2762},{"ward":7,"scenario":"SSP2-4.5","horizon":2080,"v_score":1.9291,"e_norm":0.5313,"s_norm":0.3994,"ac_norm":0.1},{"ward":8,"scenario":"SSP2-4.5","horizon":2080,"v_score":1.4684,"e_norm":0.6071,"s_norm":0.2859,"ac_norm":0.1082},{"ward":9,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.5146,"e_norm":0.5635,"s_norm":0.2665,"ac_norm":0.2818},{"ward":10,"scenario":"SSP2-4.5","horizon":2080,"v_score":3.2431,"e_norm":0.5434,"s_norm":0.7126,"ac_norm":0.1094},{"ward":11,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.1055,"e_norm":0.5313,"s_norm":0.1,"ac_norm":0.4935},{"ward":12,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.5593,"e_norm":0.499,"s_norm":0.2913,"ac_norm":0.2499},{"ward":13,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.1168,"e_norm":0.3433,"s_norm":0.3436,"ac_norm":1.0},{"ward":14,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.6777,"e_norm":0.4345,"s_norm":0.4693,"ac_norm":0.2909},{"ward":15,"scenario":"SSP2-4.5","horizon":2080,"v_score":0.8157,"e_norm":0.4716,"s_norm":0.9691,"ac_norm":0.5503}];
const EXPOSURE_DATA = [{"scenario":"SSP5-8.5","index":"TXx","label":"Baseline","year":1990,"value":33.5423},{"scenario":"SSP5-8.5","index":"TXx","label":"2030","year":2030,"value":35.5643},{"scenario":"SSP5-8.5","index":"TXx","label":"2050","year":2050,"value":36.8701},{"scenario":"SSP5-8.5","index":"TXx","label":"2080","year":2080,"value":39.3736},{"scenario":"SSP5-8.5","index":"PRCPTOT","label":"Baseline","year":1990,"value":916.0793},{"scenario":"SSP5-8.5","index":"PRCPTOT","label":"2030","year":2030,"value":963.8224},{"scenario":"SSP5-8.5","index":"PRCPTOT","label":"2050","year":2050,"value":1003.795},{"scenario":"SSP5-8.5","index":"PRCPTOT","label":"2080","year":2080,"value":1048.7009},{"scenario":"SSP5-8.5","index":"DTR","label":"Baseline","year":1990,"value":9.2095},{"scenario":"SSP5-8.5","index":"DTR","label":"2030","year":2030,"value":9.2277},{"scenario":"SSP5-8.5","index":"DTR","label":"2050","year":2050,"value":9.189},{"scenario":"SSP5-8.5","index":"DTR","label":"2080","year":2080,"value":9.1139},{"scenario":"SSP2-4.5","index":"TXx","label":"Baseline","year":1990,"value":33.5435},{"scenario":"SSP2-4.5","index":"TXx","label":"2030","year":2030,"value":35.4332},{"scenario":"SSP2-4.5","index":"TXx","label":"2050","year":2050,"value":36.2712},{"scenario":"SSP2-4.5","index":"TXx","label":"2080","year":2080,"value":37.3622},{"scenario":"SSP2-4.5","index":"PRCPTOT","label":"Baseline","year":1990,"value":916.02},{"scenario":"SSP2-4.5","index":"PRCPTOT","label":"2030","year":2030,"value":957.3138},{"scenario":"SSP2-4.5","index":"PRCPTOT","label":"2050","year":2050,"value":991.1544},{"scenario":"SSP2-4.5","index":"PRCPTOT","label":"2080","year":2080,"value":1010.9818},{"scenario":"SSP2-4.5","index":"DTR","label":"Baseline","year":1990,"value":9.2094},{"scenario":"SSP2-4.5","index":"DTR","label":"2030","year":2030,"value":9.2718},{"scenario":"SSP2-4.5","index":"DTR","label":"2050","year":2050,"value":9.2231},{"scenario":"SSP2-4.5","index":"DTR","label":"2080","year":2080,"value":9.1721}];
const SPECIES_DATA  = [{"ward":1,"dominant_species":"Norway Maple","fraxinus_pct":4.25,"invasive_pct":23.26,"s_adjusted":4.9948},{"ward":2,"dominant_species":"Norway Maple","fraxinus_pct":1.32,"invasive_pct":27.54,"s_adjusted":4.9278},{"ward":3,"dominant_species":"Norway Maple","fraxinus_pct":1.73,"invasive_pct":23.37,"s_adjusted":5.1283},{"ward":4,"dominant_species":"Norway Maple","fraxinus_pct":7.42,"invasive_pct":18.69,"s_adjusted":4.9783},{"ward":5,"dominant_species":"Black Walnut","fraxinus_pct":5.44,"invasive_pct":23.7,"s_adjusted":4.8333},{"ward":6,"dominant_species":"Norway Maple","fraxinus_pct":3.27,"invasive_pct":19.6,"s_adjusted":4.7068},{"ward":7,"dominant_species":"Norway Maple","fraxinus_pct":0.53,"invasive_pct":21.49,"s_adjusted":4.6389},{"ward":8,"dominant_species":"Norway Maple","fraxinus_pct":0.53,"invasive_pct":18.04,"s_adjusted":4.5464},{"ward":9,"dominant_species":"Norway Maple","fraxinus_pct":1.97,"invasive_pct":14.75,"s_adjusted":4.5306},{"ward":10,"dominant_species":"Norway Maple","fraxinus_pct":4.8,"invasive_pct":19.98,"s_adjusted":4.8941},{"ward":11,"dominant_species":"Shagbark Hickory","fraxinus_pct":2.98,"invasive_pct":5.53,"s_adjusted":4.3949},{"ward":12,"dominant_species":"Norway Maple","fraxinus_pct":1.16,"invasive_pct":12.66,"s_adjusted":4.5508},{"ward":13,"dominant_species":"Sugar Maple","fraxinus_pct":7.06,"invasive_pct":12.48,"s_adjusted":4.5934},{"ward":14,"dominant_species":"Norway Maple","fraxinus_pct":1.34,"invasive_pct":20.95,"s_adjusted":4.6958},{"ward":15,"dominant_species":"Norway Maple","fraxinus_pct":8.84,"invasive_pct":15.07,"s_adjusted":5.1031}];
const AC_DATA       = [{"ward":1,"canopy_pct":32.2,"native_ratio":0.3993,"shannon":4.186,"ac_raw":2.9038},{"ward":2,"canopy_pct":18.5,"native_ratio":0.3468,"shannon":4.1401,"ac_raw":1.7694},{"ward":3,"canopy_pct":19.5,"native_ratio":0.3691,"shannon":4.1464,"ac_raw":1.5474},{"ward":4,"canopy_pct":21.0,"native_ratio":0.5222,"shannon":4.0649,"ac_raw":2.2295},{"ward":5,"canopy_pct":24.0,"native_ratio":0.5126,"shannon":3.9571,"ac_raw":2.2173},{"ward":6,"canopy_pct":19.0,"native_ratio":0.4129,"shannon":4.2312,"ac_raw":1.5983},{"ward":7,"canopy_pct":17.0,"native_ratio":0.3576,"shannon":4.2152,"ac_raw":1.0284},{"ward":8,"canopy_pct":7.6,"native_ratio":0.3756,"shannon":4.3795,"ac_raw":1.0548},{"ward":9,"canopy_pct":13.0,"native_ratio":0.4442,"shannon":4.3343,"ac_raw":1.6165},{"ward":10,"canopy_pct":15.5,"native_ratio":0.4225,"shannon":4.1148,"ac_raw":1.0587},{"ward":11,"canopy_pct":17.0,"native_ratio":0.5413,"shannon":4.4133,"ac_raw":2.3012},{"ward":12,"canopy_pct":21.0,"native_ratio":0.4025,"shannon":4.3447,"ac_raw":1.5132},{"ward":13,"canopy_pct":40.3,"native_ratio":0.6312,"shannon":3.8905,"ac_raw":3.9393},{"ward":14,"canopy_pct":29.0,"native_ratio":0.4272,"shannon":4.1225,"ac_raw":1.6459},{"ward":15,"canopy_pct":24.4,"native_ratio":0.4891,"shannon":4.2835,"ac_raw":2.4848}];
const TREE_DATA     = [{"ward":1,"tree_count":24145,"park_tree_pct":34.7},{"ward":2,"tree_count":9917,"park_tree_pct":45.2},{"ward":3,"tree_count":12437,"park_tree_pct":45.0},{"ward":4,"tree_count":21534,"park_tree_pct":56.2},{"ward":5,"tree_count":27338,"park_tree_pct":60.3},{"ward":6,"tree_count":16750,"park_tree_pct":33.0},{"ward":7,"tree_count":15737,"park_tree_pct":19.3},{"ward":8,"tree_count":13208,"park_tree_pct":16.3},{"ward":9,"tree_count":18969,"park_tree_pct":27.9},{"ward":10,"tree_count":17195,"park_tree_pct":21.3},{"ward":11,"tree_count":10457,"park_tree_pct":31.1},{"ward":12,"tree_count":21923,"park_tree_pct":15.4},{"ward":13,"tree_count":31472,"park_tree_pct":63.5},{"ward":14,"tree_count":13783,"park_tree_pct":28.1},{"ward":15,"tree_count":20322,"park_tree_pct":42.5}];


/* ════ state ════ */
const HORIZONS = [2030, 2050, 2080];
const METRIC_LABEL = {
  v_score: "Vulnerability Score",
  e_norm:  "Exposure (norm.)",
  s_norm:  "Sensitivity (norm.)",
  ac_norm: "Adaptive Capacity (norm.)",
};

let scenario = "SSP5-8.5";
let hIdx     = 0;
let metric   = "v_score";

const horizon  = () => HORIZONS[hIdx];
const filtVuln = () => VULN_DATA.filter(d => d.scenario === scenario && d.horizon === horizon());

/* ════ KPIs ════ */
function updateKPIs() {
  const fv = [...filtVuln()].sort((a, b) => b.v_score - a.v_score);
  document.getElementById("k-maxward").textContent  = "Ward " + fv[0].ward;
  document.getElementById("k-maxscore").textContent = fv[0].v_score.toFixed(3);
  document.getElementById("k-minward").textContent  = "Ward " + fv[fv.length - 1].ward;

  const hl = HORIZONS[hIdx].toString();
  const get = (idx, lbl) => EXPOSURE_DATA.find(d =>
    d.scenario === scenario && d.index === idx && d.label === lbl);

  const txxNow  = get("TXx", hl);
  const txxBase = get("TXx", "Baseline");
  if (txxNow && txxBase) {
    const d = (txxNow.value - txxBase.value).toFixed(2);
    document.getElementById("k-txx").textContent = (d >= 0 ? "+" : "") + d + " °C";
  }
  const prNow  = get("PRCPTOT", hl);
  const prBase = get("PRCPTOT", "Baseline");
  if (prNow && prBase) {
    const d = Math.round(prNow.value - prBase.value);
    document.getElementById("k-precip").textContent = (d >= 0 ? "+" : "") + d + " mm";
  }
}

/* ════ Leaflet choropleth map ════ */
// colour ramp: white → deep red (5 steps)
const REDS = ["#fee5d9","#fcae91","#fb6a4a","#de2d26","#a50f15"];
// colour ramp for adaptive capacity: white → green
const GREENS = ["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c"];

function metricRange(met) {
  const vals = VULN_DATA.filter(d => d.scenario === scenario && d.horizon === horizon())
                        .map(d => d[met]);
  return [Math.min(...vals), Math.max(...vals)];
}

function colorFor(value, min, max, ramp) {
  if (max === min) return ramp[2];
  const t = Math.max(0, Math.min(1, (value - min) / (max - min)));
  const i = Math.min(ramp.length - 1, Math.floor(t * ramp.length));
  return ramp[i];
}

let leafletMap  = null;
let geojsonLayer = null;
let legendCtrl  = null;

function initMap() {
  leafletMap = L.map("map", {
    zoomControl: true,
    attributionControl: false,
  });

  // dark tile layer (CartoDB dark matter, no attribution required for local use)
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png",
    { maxZoom: 19 }
  ).addTo(leafletMap);

  // Ward label layer
  L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png",
    { maxZoom: 19, pane: "shadowPane" }
  ).addTo(leafletMap);

  renderMap();
}

function renderMap() {
  const fv   = filtVuln();
  const ramp = metric === "ac_norm" ? GREENS : REDS;
  const byWard = {};
  fv.forEach(d => { byWard[d.ward] = d; });
  const [mn, mx] = metricRange(metric);

  if (geojsonLayer) geojsonLayer.remove();

  geojsonLayer = L.geoJSON(WARD_GEO, {
    style(feature) {
      const row = byWard[feature.properties.WARD] || {};
      const val = row[metric] || 0;
      return {
        fillColor:   colorFor(val, mn, mx, ramp),
        fillOpacity: 0.72,
        color:       "#30363d",
        weight:      1,
      };
    },
    onEachFeature(feature, layer) {
      const ward = feature.properties.WARD;
      const row  = byWard[ward] || {};

      // permanent ward number label — offset per ward to avoid overlap
      const offsets = { 5: [18, 0], 12: [0, 18] };
      const off = offsets[ward] || [0, 0];
      layer.bindTooltip(`${ward}`, {
        permanent: true,
        direction: "center",
        className: "ward-label-tooltip",
        offset: off,
      });

      layer.bindPopup(`
        <strong>Ward ${ward}</strong><br/>
        V-Score: <b>${(row.v_score||0).toFixed(3)}</b><br/>
        Exposure: ${(row.e_norm||0).toFixed(3)}<br/>
        Sensitivity: ${(row.s_norm||0).toFixed(3)}<br/>
        Adaptive Cap.: ${(row.ac_norm||0).toFixed(3)}
      `);
      layer.on("mouseover", function() {
        this.setStyle({ fillOpacity: 0.95, weight: 2, color: "#58a6ff" });
        this.openPopup();
      });
      layer.on("mouseout", function() {
        geojsonLayer.resetStyle(this);
        this.closePopup();
      });
    }
  }).addTo(leafletMap);

  leafletMap.fitBounds(geojsonLayer.getBounds(), { padding: [10, 10] });

  // legend
  if (legendCtrl) legendCtrl.remove();
  legendCtrl = L.control({ position: "bottomright" });
  legendCtrl.onAdd = function() {
    const div  = L.DomUtil.create("div", "map-legend");
    const step = (mx - mn) / (ramp.length - 1);
    const gradient = ramp.join(",");
    div.innerHTML = `
      <strong>${METRIC_LABEL[metric]}</strong>
      <div class="legend-bar"
           style="background:linear-gradient(to right,${gradient})"></div>
      <div class="legend-ticks">
        <span>${mn.toFixed(2)}</span>
        <span>${((mn+mx)/2).toFixed(2)}</span>
        <span>${mx.toFixed(2)}</span>
      </div>`;
    return div;
  };
  legendCtrl.addTo(leafletMap);
}

/* ════ Vega-Lite helpers ════ */
const CFG = {
  background: "#161b22",
  view: { stroke: null },
  axis: { domain: false, gridColor: "#21262d",
          labelColor: "#8b949e", titleColor: "#8b949e" },
  legend: { titleColor: "#8b949e", labelColor: "#e6edf3" },
};
const EMBED_OPTS = { actions: false, renderer: "svg", config: CFG };

function cw(id) {
  const el = document.getElementById(id);
  return Math.max(el.getBoundingClientRect().width - 4, 260);
}

/* ── bar chart ── */
function specBar() {
  const vals = filtVuln().map(d => ({ ...d, lbl: "W" + d.ward }));
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: cw("vg-bar"), height: 260, autosize: "none",
    data: { values: vals },
    mark: { type: "bar", cornerRadiusTopLeft: 3, cornerRadiusTopRight: 3 },
    encoding: {
      x: { field: "lbl", type: "ordinal", sort: "-y", title: "Ward",
           axis: { labelAngle: -45, labelFontSize: 10 } },
      y: { field: "v_score", type: "quantitative", title: "V-Score" },
      color: { field: "v_score", type: "quantitative",
               scale: { scheme: "reds" }, legend: null },
      tooltip: [
        { field: "lbl",     title: "Ward" },
        { field: "v_score", title: "V-Score",          format: ".3f" },
        { field: "e_norm",  title: "Exposure",          format: ".3f" },
        { field: "s_norm",  title: "Sensitivity",       format: ".3f" },
        { field: "ac_norm", title: "Adaptive Capacity", format: ".3f" },
      ],
    },
  };
}

/* ── trend line ── */
function specTrend() {
  const rows = EXPOSURE_DATA.filter(d => d.index === "TXx");
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: cw("vg-trend"), height: 260, autosize: "none",
    data: { values: rows },
    layer: [
      {
        mark: { type: "line", point: { filled: true, size: 55 } },
        encoding: {
          x: { field: "year", type: "quantitative", title: "Year",
               scale: { domain: [1985, 2085] },
               axis: { values: [1990, 2030, 2050, 2080],
                       labelExpr: "datum.value===1990?'Baseline':datum.value" } },
          y: { field: "value", type: "quantitative", title: "TXx (°C)",
               scale: { zero: false } },
          color: {
            field: "scenario", type: "nominal",
            scale: { domain: ["SSP5-8.5","SSP2-4.5"], range: ["#f85149","#58a6ff"] },
            legend: { title: "Scenario" },
          },
          tooltip: [
            { field: "scenario", title: "Scenario" },
            { field: "label",    title: "Horizon" },
            { field: "value",    title: "TXx (°C)", format: ".2f" },
          ],
        },
      },
      {
        data: { values: [{ x: horizon() }] },
        mark: { type: "rule", strokeDash: [5, 4], color: "#555", strokeWidth: 1.5 },
        encoding: { x: { field: "x", type: "quantitative" } },
      },
    ],
  };
}

/* ── decomposition stacked bar ── */
function specDecomp() {
  const rows = [];
  filtVuln().forEach(d => {
    rows.push({ lbl: "W"+d.ward, comp: "Exposure",      val: d.e_norm,  ord: 1 });
    rows.push({ lbl: "W"+d.ward, comp: "Sensitivity",   val: d.s_norm,  ord: 2 });
    rows.push({ lbl: "W"+d.ward, comp: "Adaptive Cap.", val: d.ac_norm, ord: 3 });
  });
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: cw("vg-decomp"), height: 260, autosize: "none",
    data: { values: rows },
    mark: { type: "bar" },
    encoding: {
      x:     { field: "lbl",  type: "ordinal", title: "Ward",
                axis: { labelAngle: -45, labelFontSize: 10 } },
      y:     { field: "val",  type: "quantitative", stack: true, title: "Normalised Score" },
      color: { field: "comp", type: "nominal",
               scale: { domain: ["Exposure","Sensitivity","Adaptive Cap."],
                        range: ["#f85149","#d29922","#3fb950"] },
               legend: { title: "Component" } },
      order: { field: "ord", type: "quantitative" },
      tooltip: [
        { field: "lbl",  title: "Ward" },
        { field: "comp", title: "Component" },
        { field: "val",  title: "Value", format: ".3f" },
      ],
    },
  };
}

/* ── species scatter ── */
function specSpecies() {
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: cw("vg-species"), height: 260, autosize: "none",
    data: { values: SPECIES_DATA },
    layer: [
      {
        mark: { type: "circle", opacity: 0.85 },
        encoding: {
          x:     { field: "fraxinus_pct", type: "quantitative", title: "Fraxinus (Ash) %" },
          y:     { field: "invasive_pct", type: "quantitative", title: "Invasive Species %" },
          size:  { field: "s_adjusted",   type: "quantitative",
                   scale: { range: [60, 500] }, legend: { title: "Sensitivity" } },
          color: { value: "#f85149" },
          tooltip: [
            { field: "ward",             title: "Ward" },
            { field: "dominant_species", title: "Dominant Species" },
            { field: "fraxinus_pct",     title: "Fraxinus %",  format: ".1f" },
            { field: "invasive_pct",     title: "Invasive %",  format: ".1f" },
            { field: "s_adjusted",       title: "Sensitivity", format: ".3f" },
          ],
        },
      },
      {
        mark: { type: "text", dy: -12, fontSize: 10, color: "#8b949e" },
        encoding: {
          x:    { field: "fraxinus_pct", type: "quantitative" },
          y:    { field: "invasive_pct", type: "quantitative" },
          text: { field: "ward",         type: "quantitative" },
        },
      },
    ],
  };
}

/* ── canopy bars ── */
function specCanopy() {
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: cw("vg-canopy"), height: 240, autosize: "none",
    data: { values: AC_DATA },
    mark: { type: "bar", cornerRadiusTopLeft: 3, cornerRadiusTopRight: 3,
            color: "#3fb950", opacity: 0.85 },
    encoding: {
      x:     { field: "ward",       type: "ordinal",      title: "Ward",
                axis: { labelFontSize: 11 } },
      y:     { field: "canopy_pct", type: "quantitative", title: "Canopy Cover %" },
      tooltip: [
        { field: "ward",         title: "Ward" },
        { field: "canopy_pct",   title: "Canopy %",      format: ".1f" },
        { field: "native_ratio", title: "Native Ratio",  format: ".2f" },
        { field: "shannon",      title: "Shannon H",     format: ".3f" },
        { field: "ac_raw",       title: "Adaptive Cap.", format: ".3f" },
      ],
    },
  };
}

/* ── tree count bars ── */
function specTrees() {
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    width: cw("vg-trees"), height: 240, autosize: "none",
    data: { values: TREE_DATA },
    mark: { type: "bar", cornerRadiusTopLeft: 3, cornerRadiusTopRight: 3,
            color: "#58a6ff", opacity: 0.85 },
    encoding: {
      x:     { field: "ward",       type: "ordinal",      title: "Ward",
                axis: { labelFontSize: 11 } },
      y:     { field: "tree_count", type: "quantitative", title: "Tree Count" },
      tooltip: [
        { field: "ward",          title: "Ward" },
        { field: "tree_count",    title: "Total Trees" },
        { field: "park_tree_pct", title: "Park Trees %", format: ".1f" },
      ],
    },
  };
}

/* ════ render all ════ */
async function renderCharts() {
  await Promise.all([
    vegaEmbed("#vg-bar",     specBar(),     EMBED_OPTS),
    vegaEmbed("#vg-trend",   specTrend(),   EMBED_OPTS),
    vegaEmbed("#vg-decomp",  specDecomp(),  EMBED_OPTS),
    vegaEmbed("#vg-species", specSpecies(), EMBED_OPTS),
    vegaEmbed("#vg-canopy",  specCanopy(),  EMBED_OPTS),
    vegaEmbed("#vg-trees",   specTrees(),   EMBED_OPTS),
  ]);
}

function refreshAll() {
  updateKPIs();
  renderMap();
  renderCharts();
}

/* ════ controls ════ */
document.getElementById("sel-scenario").addEventListener("change", e => {
  scenario = e.target.value; refreshAll();
});
document.getElementById("slider").addEventListener("input", e => {
  hIdx = +e.target.value; refreshAll();
});
document.getElementById("sel-metric").addEventListener("change", e => {
  metric = e.target.value;
  renderMap();   // only map uses metric selector
});

/* ════ init ════ */
window.addEventListener("load", () => {
  initMap();
  updateKPIs();
  renderCharts();
});
</script>
</body>
</html>
